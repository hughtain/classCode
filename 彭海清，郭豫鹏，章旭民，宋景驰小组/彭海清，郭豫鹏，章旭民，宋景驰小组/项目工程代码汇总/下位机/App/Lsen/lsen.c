#include "lsen.h"
#include "UnItdelay.h"


//???ADC3
//????????????
//?????????7	  
void  Adc3_Init(void)
{      
			ADC_InitTypeDef ADC_InitStructure; 


			RCC_APB2PeriphClockCmd(RCC_APB2Periph_ADC3,ENABLE);	 //??ADC3????
			RCC_APB2PeriphResetCmd(RCC_APB2Periph_ADC3,ENABLE);//ADC??
			RCC_APB2PeriphResetCmd(RCC_APB2Periph_ADC3,DISABLE);//????	   

			ADC_DeInit(ADC3);  //??ADC3,??? ADC3????????????

			ADC_InitStructure.ADC_Mode = ADC_Mode_Independent;	//ADC????: ????
			ADC_InitStructure.ADC_ScanConvMode = DISABLE;	//????????????
			ADC_InitStructure.ADC_ContinuousConvMode = DISABLE;	//?????????????
			ADC_InitStructure.ADC_ExternalTrigConv = ADC_ExternalTrigConv_None;	//??????????????
			ADC_InitStructure.ADC_DataAlign = ADC_DataAlign_Right;	//ADC?????
			ADC_InitStructure.ADC_NbrOfChannel = 1;	//?????????ADC?????
			ADC_Init(ADC3, &ADC_InitStructure);	//??ADC_InitStruct???????????ADCx????  


			ADC_Cmd(ADC3, ENABLE);	//?????ADC3

			ADC_ResetCalibration(ADC3);	//??????  
			 
			while(ADC_GetResetCalibrationStatus(ADC3));	//????????

			ADC_StartCalibration(ADC3);	//??AD??
			 
			while(ADC_GetCalibrationStatus(ADC3));	//??????
}	 

u16 Get_Adc3(u8 ch)   
{
  //????ADC??????,????,????
			ADC_RegularChannelConfig(ADC3, ch, 1, ADC_SampleTime_239Cycles5 );	//ADC3,ADC??,?????239.5??
			ADC_SoftwareStartConvCmd(ADC3, ENABLE);	//?????ADC3?????????	
			while(!ADC_GetFlagStatus(ADC3, ADC_FLAG_EOC ));//??????
			return ADC_GetConversionValue(ADC3);	//??????ADC3????????
} 


void Lsen_Init(void)
{
			GPIO_InitTypeDef GPIO_InitStructure;
			RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOF,ENABLE);//??PORTF??	
			GPIO_InitStructure.GPIO_Pin = GPIO_Pin_9;//PF9 anolog??
			GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AIN;	//??????
			GPIO_Init(GPIOF, &GPIO_InitStructure);	
			Adc3_Init();
}
u8 Lsens_Get_Val(void)
{
			u32 temp_val=0;
			u8 t;
			for(t=0;t<200;t++)
			{
			temp_val+=Get_Adc3(ADC_Channel_7);	//??ADC?
			unitdelay_ms(5);
				
			}

			 temp_val/=200;//????? 
			 if(temp_val>4000)temp_val=4000;
			 return (u8)(100-(temp_val/40));	
}
